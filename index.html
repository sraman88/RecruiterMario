import React, { useMemo, useState, useEffect } from "react";

/**
 * TALENTRON – LEVEL 1: JOB QUEST (Prototype v0.1)
 * ------------------------------------------------
 * \- Mobile + PC friendly (touch/click)
 * \- No persistence: all state lives in-memory and resets on refresh
 * \- Goal: Match a Job Description (JD) to the best-fit candidate card
 * \- Scoring: Accuracy + Speed bonus; Mistakes cost points/time
 * \- Styling: Tailwind utility classes
 */

// --- Sample OpenText-flavored roles (fictionalized placeholders) ---
const JOBS = [
  {
    id: "jd1",
    title: "Senior Software Engineer – Content Services",
    band: "P4",
    location: "Bengaluru / Hyderabad",
    summary:
      "Build scalable services and APIs for document & content lifecycle products.",
    mustHave: ["Java", "Spring", "REST APIs", "Cloud", "Microservices"],
    niceToHave: ["Kubernetes", "ElasticSearch", "Kafka", "CI/CD"],
  },
  {
    id: "jd2",
    title: "Technical Support Specialist – Information Management",
    band: "P3",
    location: "Chennai / Remote India",
    summary:
      "Resolve L2/L3 cases, reproduce issues, and drive customer happiness for IM suites.",
    mustHave: ["Customer Support", "Troubleshooting", "Linux/Windows", "SQL"],
    niceToHave: ["SaaS", "Networking", "Scripting"],
  },
  {
    id: "jd3",
    title: "Implementation Consultant – Cloud Services",
    band: "P4",
    location: "Bengaluru / Pune",
    summary:
      "Own end‑to‑end deployments, integrations, and go‑lives for enterprise customers.",
    mustHave: ["Client Facing", "Integration", "APIs", "Project Delivery"],
    niceToHave: ["JavaScript", "ETL", "SAML/OAuth"],
  },
];

// --- Candidate cards: skills/tags used for simple matching logic ---
const CANDIDATES = [
  {
    id: "c1",
    name: "Aarav S.",
    headline: "Backend Engineer @ SaaS",
    tags: ["Java", "Spring", "REST APIs", "Microservices", "Kubernetes"],
    notes: "Built multi‑tenant API gateway; 6y exp",
  },
  {
    id: "c2",
    name: "Meera K.",
    headline: "L3 Support Analyst",
    tags: ["Customer Support", "Troubleshooting", "SQL", "Linux/Windows", "SaaS"],
    notes: "99% CSAT; deep log analysis",
  },
  {
    id: "c3",
    name: "Rahul T.",
    headline: "Implementation / Integrations",
    tags: ["Client Facing", "APIs", "Integration", "Project Delivery", "SAML/OAuth"],
    notes: "Led 12 enterprise go‑lives",
  },
  {
    id: "c4",
    name: "Priya N.",
    headline: "Frontend Engineer",
    tags: ["React", "TypeScript", "UX", "Accessibility"],
    notes: "Design‑systems experience",
  },
  {
    id: "c5",
    name: "Kavin R.",
    headline: "DBA / Data Ops",
    tags: ["SQL", "Postgres", "Performance Tuning", "ETL"],
    notes: "Cost‑savvy indexing",
  },
];

function useCountdown(seconds, running) {
  const [timeLeft, setTimeLeft] = useState(seconds);
  useEffect(() => {
    if (!running) return;
    setTimeLeft(seconds);
    const i = setInterval(() => {
      setTimeLeft((t) => (t > 0 ? t - 1 : 0));
    }, 1000);
    return () => clearInterval(i);
  }, [seconds, running]);
  return timeLeft;
}

function pickRound() {
  const jd = JOBS[Math.floor(Math.random() * JOBS.length)];
  // choose the best candidate by overlap with mustHave
  const scored = CANDIDATES.map((c) => ({
    c,
    score: jd.mustHave.filter((m) => c.tags.includes(m)).length,
  }))
    .sort((a, b) => b.score - a.score)
    .map((x) => x.c);
  // top 1 + two distractors
  const pool = [scored[0]];
  const others = CANDIDATES.filter((c) => c.id !== scored[0].id);
  while (pool.length < 3 && others.length) {
    const idx = Math.floor(Math.random() * others.length);
    pool.push(others.splice(idx, 1)[0]);
  }
  return { jd, options: shuffle(pool), answerId: scored[0].id };
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

export default function TalentronLevel1() {
  const ROUND_TIME = 45; // seconds per round
  const [round, setRound] = useState(pickRound());
  const [running, setRunning] = useState(true);
  const [score, setScore] = useState(0);
  const [streak, setStreak] = useState(0);
  const [feedback, setFeedback] = useState("");
  const [attempted, setAttempted] = useState(false);
  const timeLeft = useCountdown(ROUND_TIME, running);

  useEffect(() => {
    if (timeLeft === 0) {
      setRunning(false);
      setFeedback("Time's up! Tap Next Round to continue.");
    }
  }, [timeLeft]);

  const speedMultiplier = useMemo(() => {
    // 1.5x if finish with > 60% time remaining, else scale from 1.0
    const pct = timeLeft / ROUND_TIME;
    return pct > 0.6 ? 1.5 : 1 + pct * 0.5; // 1.0 .. 1.5
  }, [timeLeft]);

  function handlePick(id) {
    if (!running) return;
    setAttempted(true);
    const correct = id === round.answerId;
    if (correct) {
      const base = 100;
      const accuracy = 50; // process adherence bonus analogue
      const gained = Math.round((base + accuracy + streak * 10) * speedMultiplier);
      setScore((s) => s + gained);
      setStreak((k) => k + 1);
      setFeedback(`✅ Correct! +${gained} (streak ${streak + 1})`);
      setRunning(false);
    } else {
      setScore((s) => Math.max(0, s - 30));
      setStreak(0);
      setFeedback("❌ Not the best-fit. Try another card.");
    }
  }

  function nextRound() {
    setRound(pickRound());
    setRunning(true);
    setFeedback("");
    setAttempted(false);
  }

  function resetAll() {
    // Soft reset (no persistence by design)
    setScore(0);
    setStreak(0);
    nextRound();
  }

  return (
    <div className="min-h-screen w-full bg-neutral-900 text-cyan-100 flex flex-col items-center px-4 py-6">
      <header className="w-full max-w-5xl flex items-center justify-between mb-4">
        <h1 className="text-2xl md:text-3xl font-extrabold tracking-wider">TALENTRON • Level 1: Job Quest</h1>
        <div className="text-xs md:text-sm opacity-80">Session Privacy: values are not stored</div>
      </header>

      <div className="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-12 gap-4">
        {/* JD Panel */}
        <section className="lg:col-span-5 bg-neutral-800/70 border border-cyan-700/30 rounded-2xl p-5 shadow-xl">
          <h2 className="text-xl font-bold mb-3">Job Description</h2>
          <div className="space-y-2">
            <div className="text-lg font-semibold">{round.jd.title}</div>
            <div className="text-sm opacity-80">Band: {round.jd.band} • Location: {round.jd.location}</div>
            <p className="text-sm mt-3">{round.jd.summary}</p>
            <div className="mt-3">
              <div className="text-sm font-semibold mb-1">Must‑have skills</div>
              <div className="flex flex-wrap gap-2">
                {round.jd.mustHave.map((s) => (
                  <span key={s} className="px-2 py-1 rounded-full bg-cyan-900/40 border border-cyan-600/40 text-xs">{s}</span>
                ))}
              </div>
            </div>
            <div className="mt-2">
              <div className="text-sm font-semibold mb-1">Nice‑to‑have</div>
              <div className="flex flex-wrap gap-2">
                {round.jd.niceToHave.map((s) => (
                  <span key={s} className="px-2 py-1 rounded-full bg-neutral-700/50 border border-neutral-600/40 text-xs">{s}</span>
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* Candidate Options */}
        <section className="lg:col-span-7 grid grid-cols-1 md:grid-cols-3 gap-4">
          {round.options.map((c) => (
            <button
              key={c.id}
              onClick={() => handlePick(c.id)}
              className="text-left bg-neutral-800/70 border border-cyan-700/30 rounded-2xl p-4 hover:border-cyan-400/60 active:scale-[.99] transition"
              aria-label={`Pick candidate ${c.name}`}
            >
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold">{c.name}</div>
                <span className="text-[10px] px-2 py-0.5 rounded-full bg-cyan-900/40 border border-cyan-700/40">{c.headline}</span>
              </div>
              <div className="text-xs opacity-80 mb-2">{c.notes}</div>
              <div className="flex flex-wrap gap-2">
                {c.tags.slice(0, 6).map((t) => (
                  <span key={t} className="px-2 py-1 rounded-full bg-neutral-700/60 text-[10px] border border-neutral-600/50">{t}</span>
                ))}
              </div>
            </button>
          ))}
        </section>
      </div>

      {/* Footer HUD */}
      <footer className="w-full max-w-5xl mt-4 flex flex-col md:flex-row items-center gap-3 md:gap-6">
        <div className="flex-1 bg-neutral-800/70 border border-neutral-700 rounded-2xl p-3 flex items-center justify-between">
          <div>⏱️ Time Left: <span className="font-bold">{timeLeft}s</span></div>
          <div>Score: <span className="font-bold">{score}</span></div>
          <div>Streak: <span className="font-bold">{streak}</span></div>
        </div>
        <div className="flex items-center gap-2">
          <button onClick={nextRound} className="px-4 py-2 rounded-2xl bg-cyan-700 hover:bg-cyan-600">Next Round</button>
          <button onClick={resetAll} className="px-4 py-2 rounded-2xl bg-neutral-700 hover:bg-neutral-600">Reset</button>
        </div>
      </footer>

      {/* Feedback */}
      {feedback && (
        <div className="mt-4 text-sm md:text-base">{feedback}</div>
      )}

      {/* Teaching hint (first attempt only) */}
      {!attempted && running && (
        <div className="mt-3 text-xs opacity-80">Hint: Pick the candidate whose skills overlap the most with the JD's must‑haves.</div>
      )}

      {/* Legal / privacy note */}
      <div className="mt-6 text-[10px] opacity-60">All content here is for demo only; no personal data is stored, transmitted, or persisted.</div>
    </div>
  );
}
